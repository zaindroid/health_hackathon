<!DOCTYPE html>
<html lang="en" style="height: 100%; overflow: hidden;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Anatomy Viewer - With Python API</title>

    <!-- jQuery (required for Human Components) -->
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>

    <!-- Human Components -->
    <link rel="stylesheet" href="https://developer.biodigital.com/builds/human-components/1.0.0/css/human-components.css">
    <script src="https://developer.biodigital.com/builds/human-components/1.0.0/js/human-components.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            background-color: #f7f9fb;
        }
        #myWidget {
            flex-grow: 1;
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        /* ADDED: Styling for the buttons created by the Anatomy Scanner */
        .anatomy-object {
            @apply inline-flex items-center px-3 py-1 bg-indigo-200 text-indigo-800 text-xs font-medium rounded-full mr-2 mb-2 transition duration-150 ease-in-out hover:bg-indigo-300 cursor-pointer;
            border: none;
            outline: none;
        }
    </style>
</head>
<body class="p-4">

    <!-- Title and Instructions -->
    <div class="mb-4 text-center">
        <h1 class="text-3xl font-bold text-gray-800">3D Anatomy Viewer - Python API Integration</h1>
        <p class="text-sm text-gray-500 mt-1">Navigation powered by Python tool calls</p>
        <p class="text-xs text-gray-400 mt-1">
            <span class="font-semibold text-indigo-600">Architecture:</span>
            JavaScript Frontend → Flask API → Python Navigator → Database Lookup → Camera Pan
        </p>
    </div>

    <!-- API Status -->
    <div id="api-status" class="mb-4 p-3 bg-gray-100 rounded-lg text-center">
        <span class="text-sm text-gray-600">API Status: <span id="status-text" class="font-semibold">Checking...</span></span>
    </div>

    <!-- Muscle Search Panel -->
    <div class="mb-4 p-4 bg-white rounded-xl shadow-lg">
        <h3 class="text-lg font-bold text-gray-800 mb-3">Search & Highlight Muscles</h3>
        <div class="flex gap-2">
            <input type="text"
                   id="muscle-search"
                   placeholder="Enter muscle name (e.g., trapezius, deltoid)..."
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                   onkeyup="if(event.key === 'Enter') searchMuscle()">
            <button onclick="searchMuscle()"
                    class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                Search
            </button>
            <button onclick="clearHighlight()"
                    class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150">
                Clear
            </button>
        </div>
        <div id="search-results" class="mt-3 text-sm text-gray-600"></div>
        <!-- This element receives text output which the scanner converts to buttons -->
        <div id="muscle-results" data-scantext data-target="myWidget" class="mt-3 p-2"></div>
    </div>

    <!-- Camera Control Buttons (Using Python API) -->
    <div id="controls" class="flex flex-wrap justify-center gap-3 p-3 bg-white rounded-xl shadow-lg mb-4">
        <button id="btn-front" onclick="navigateUsingAPI('front')" disabled class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
            Front View (API)
        </button>
        <button id="btn-side" onclick="navigateUsingAPI('right-shoulder')" disabled class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
            Right Shoulder (API)
        </button>
        <button id="btn-head" onclick="navigateUsingAPI('back')" disabled class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
            Back View (API)
        </button>
        <button id="btn-legs" onclick="navigateUsingAPI('left-shoulder')" disabled class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
            Left Shoulder (API)
        </button>
    </div>

    <!-- API Call Log -->
    <div class="mb-4 p-4 bg-white rounded-xl shadow-lg">
        <h3 class="text-lg font-bold text-gray-800 mb-3">API Call Log</h3>
        <div id="api-log" class="bg-gray-50 p-3 rounded border border-gray-300 h-32 overflow-y-auto font-mono text-xs">
            <div class="text-gray-500">Waiting for API calls...</div>
        </div>
    </div>

    <!-- BioDigital Human Viewer Iframe -->
    <iframe id="myWidget"
          src="https://human.biodigital.com/viewer/?id=6cr6&ui-anatomy-descriptions=true&ui-anatomy-pronunciations=true&ui-anatomy-labels=true&ui-audio=true&ui-chapter-list=false&ui-fullscreen=true&ui-help=true&ui-info=true&ui-label-list=true&ui-layers=true&ui-skin-layers=true&ui-loader=circle&ui-media-controls=full&ui-menu=true&ui-nav=true&ui-search=true&ui-tools=true&ui-tutorial=false&ui-undo=true&ui-whiteboard=true&initial.none=true&disable-scroll=false&uaid=ML3xE&paid=o_22e32b94"
          width="100%"
          height="100%"
          allow="xr-spatial-tracking">
    </iframe>

    <!-- Load the HumanAPI script -->
    <script src="https://developer.biodigital.com/builds/api/human-api-3.0.0.min.js"></script>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:5000/api';
        let human = null;
        let sceneObjects = {}; // Store scene objects for searching
        let highlightedObjects = []; // Track currently highlighted objects

        // ADDED: Configuration for the Anatomy Scanner Component to strip common prefixes
        const SCANNER_TO_STRIP_REGEX = /^left\s|right\s|bones\sof\sthe\s/i; 
        
        // API Call Logger
        function logAPICall(endpoint, method, data, response) {
            const logDiv = document.getElementById('api-log');
            const timestamp = new Date().toLocaleTimeString();

            const logEntry = document.createElement('div');
            logEntry.className = 'mb-2 pb-2 border-b border-gray-200';
            logEntry.innerHTML = `
                <div class="text-blue-600 font-semibold">[${timestamp}] ${method} ${endpoint}</div>
                ${data ? `<div class="text-gray-600">Request: ${JSON.stringify(data)}</div>` : ''}
                <div class="text-green-600">Response: ${JSON.stringify(response, null, 2)}</div>
            `;

            // Clear the "waiting" message if it exists
            if (logDiv.querySelector('.text-gray-500')) {
                logDiv.innerHTML = '';
            }

            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Check API health status
        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();

                const statusText = document.getElementById('status-text');
                if (response.ok) {
                    statusText.textContent = 'Connected';
                    statusText.className = 'font-semibold text-green-600';
                    return true;
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                const statusText = document.getElementById('status-text');
                statusText.textContent = 'Disconnected (using local fallback)';
                statusText.className = 'font-semibold text-red-600';
                console.error('API connection failed:', error);
                return false;
            }
        }

        // Navigate using Python API (TOOL CALL)
        async function navigateUsingAPI(viewpointId) {
            if (!human) {
                console.error("HumanAPI not initialized.");
                return;
            }

            console.log(`[TOOL CALL] Requesting navigation to: ${viewpointId}`);

            // Show loading state
            const buttons = document.querySelectorAll('#controls button');
            buttons.forEach(btn => btn.classList.add('loading'));

            try {
                // Step 1: Call Python API to get camera coordinates
                console.log(`Step 1: Calling Python API endpoint /api/navigate/${viewpointId}`);
                const response = await fetch(`${API_BASE_URL}/navigate/${viewpointId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_id: 'neck_shoulders_upper_back'
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.statusText}`);
                }

                const cameraCommand = await response.json();
                console.log('Step 2: Received camera coordinates from database:', cameraCommand);

                // Log the API call
                logAPICall(`/navigate/${viewpointId}`, 'POST', { model_id: 'neck_shoulders_upper_back' }, cameraCommand);

                // Check if there was an error
                if (cameraCommand.error) {
                    console.error('API returned error:', cameraCommand.error);
                    console.error(`Navigation failed: ${cameraCommand.error}`); // Replaced alert()
                    return;
                }

                // Step 3: Send camera command to BioDigital viewer
                console.log('Step 3: Sending camera pan command to 3D viewer...');
                human.send("camera.set", {
                    position: cameraCommand.params.position,
                    target: cameraCommand.params.target,
                    animate: cameraCommand.params.animate,
                    duration: cameraCommand.params.duration
                });

                console.log(`[SUCCESS] Camera panned to ${viewpointId} view`);

            } catch (error) {
                console.error('Navigation error:', error);
                console.error(`Failed to navigate: ${error.message}\n\nMake sure the Flask API server is running (python web_integration.py)`); // Replaced alert()
            } finally {
                // Remove loading state
                buttons.forEach(btn => btn.classList.remove('loading'));
            }
        }

        // Load scene objects for muscle search
        function loadSceneObjects() {
            if (!human) {
                console.error("HumanAPI not initialized.");
                return;
            }

            console.log("Loading scene objects for muscle search...");
            human.send("scene.info", function(data) {
                sceneObjects = data.objects;
                console.log(`Loaded ${Object.keys(sceneObjects).length} scene objects`);
            });
        }

        // MODIFIED: Search function now uses the Anatomy Scanner component
        async function searchMuscle() {
            const searchTerm = document.getElementById('muscle-search').value.trim();
            const resultsDiv = document.getElementById('search-results');
            const muscleResultsDiv = document.getElementById('muscle-results');

            if (!searchTerm) {
                resultsDiv.innerHTML = '<span class="text-red-600">Please enter a muscle name</span>';
                muscleResultsDiv.innerHTML = ''; // Clear previous output
                return;
            }

            if (!human) {
                resultsDiv.innerHTML = '<span class="text-red-600">3D Viewer not ready</span>';
                return;
            }

            if (Object.keys(sceneObjects).length === 0) {
                resultsDiv.innerHTML = '<span class="text-yellow-600">Loading scene data...</span>';
                loadSceneObjects();
                return;
            }

            console.log(`Searching for: ${searchTerm}`);
            resultsDiv.innerHTML = '<span class="text-blue-600">Searching...</span>';
            muscleResultsDiv.innerHTML = ''; // Clear output area before search


            try {
                // Call Python API to search
                const response = await fetch(`${API_BASE_URL}/search/anatomy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        searchTerm: searchTerm,
                        sceneObjects: sceneObjects
                    })
                });

                const result = await response.json();
                console.log('Search result:', result);

                // Log the API call
                logAPICall('/search/anatomy', 'POST', { searchTerm }, result);

                if (result.error || !result.success) {
                    resultsDiv.innerHTML = `<span class="text-red-600">Error: ${result.error || 'Unknown API error'}</span>`;
                    return;
                }

                if (result.matchCount === 0) {
                    resultsDiv.innerHTML = `<span class="text-yellow-600">No anatomy objects found matching "${searchTerm}"</span>`;
                    muscleResultsDiv.innerHTML = '';
                    return;
                }

                // Store for later clearing
                highlightedObjects = result.matches.map(m => m.objectId);

                // Show results message
                resultsDiv.innerHTML = `<span class="text-green-600 font-semibold">Found ${result.matchCount} anatomical object(s). Click a name below to focus.</span>`;

                // --- INTEGRATE ANATOMY SCANNER HERE ---

                // 1. Prepare text containing all found muscle names (separated by space ' ' for scanner tokenization)
                const muscleText = result.matches.map(m => m.name).join(' '); // Use space for proper tokenization

                // 2. Inject the raw text into the data-scantext div
                muscleResultsDiv.innerHTML = `
                    <div class="text-xs text-gray-700 mb-2">Click any name below to highlight and focus:</div>
                    <span class="text-lg font-mono text-gray-800">${muscleText}</span>
                `;
                
                // 3. Initialize the Anatomy Scanner component.
                if (typeof $.fn.scanner === 'function') {
                    // This is the core instruction: use the jQuery scanner component
                    $(muscleResultsDiv).scanner({
                        toStrip: SCANNER_TO_STRIP_REGEX,
                        formatData: 'focus' // This setting automatically creates focus buttons
                    });
                } else {
                     console.error("jQuery scanner function not found. Did human-components.min.js load correctly?");
                }
                
                // 4. Preserve existing auto-focus logic for immediate feedback
                if (result.matches.length > 0) {
                    const firstMuscle = result.matches[0];
                    console.log('Auto-focusing on first muscle:', firstMuscle.name, 'ID:', firstMuscle.objectId);
                    
                    human.send("camera.flyTo", { objectId: firstMuscle.objectId });
                    human.send("anatomy.select", { objectIds: [firstMuscle.objectId] });
                }

            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `<span class="text-red-600">Search failed: ${error.message}</span>`;
            }
        }

        // Clear all highlights
        function clearHighlight() {
            if (!human) {
                console.error("HumanAPI not initialized.");
                return;
            }

            console.log('Clearing highlights...');

            // Clear the tracking array
            highlightedObjects = [];

            document.getElementById('search-results').innerHTML = '';
            document.getElementById('muscle-search').value = '';
            document.getElementById('muscle-results').innerHTML = ''; // Clear scanner output

            // Reset camera to default front view
            navigateUsingAPI('front');
        }

        // Initialize the HumanAPI and enable buttons once the viewer is ready
        window.addEventListener('DOMContentLoaded', async function() {
            console.log("DOM loaded, checking API status...");

            // Check API status
            await checkAPIStatus();

            console.log("Initializing HumanAPI...");

            if (typeof HumanAPI !== 'undefined') {
                try {
                    human = new HumanAPI("myWidget");

                    human.on("human.ready", function() {
                        console.log("BioDigital Viewer is ready. Enabling controls.");

                        // Enable all camera control buttons
                        document.querySelectorAll('#controls button').forEach(button => {
                            button.disabled = false;
                        });

                        // Load scene objects for muscle search
                        loadSceneObjects();

                        // Set the default view using API
                        navigateUsingAPI('front');
                    });

                    human.on("human.error", function(error) {
                        console.error("BioDigital Viewer error:", error);
                        console.error("Error loading 3D viewer. Please check console for details."); // Replaced alert()
                    });

                } catch (error) {
                    console.error("Error initializing HumanAPI:", error);
                    console.error("Failed to initialize 3D viewer: " + error.message); // Replaced alert()
                }

            } else {
                console.error("BioDigital HumanAPI script failed to load.");
                console.error("3D Viewer library not loaded. Please check your internet connection."); // Replaced alert()
            }
        });
    </script>
</body>
</html>
